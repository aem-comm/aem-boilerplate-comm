/*! Copyright 2024 Adobe
All Rights Reserved. */
import{jsx as r,jsxs as w}from"@dropins/tools/preact-jsx-runtime.js";import{classes as q,Slot as B}from"@dropins/tools/lib.js";import{Icon as H,Checkbox as $,Button as A,CartItem as W,Image as j,Header as V,InLineAlert as Z}from"@dropins/tools/components.js";import{u as D,a as U}from"../chunks/OrderCancel.js";import{useState as O,useRef as z,useEffect as P,useCallback as F}from"@dropins/tools/preact-hooks.js";import{events as G}from"@dropins/tools/event-bus.js";import{s as J}from"../chunks/setTaxStatus.js";import{createRef as K,Fragment as X}from"@dropins/tools/preact.js";import{s as Y,p as I,r as ee,m as te}from"../chunks/returnOrdersHelper.js";import{g as ne,r as re}from"../chunks/requestReturn.js";import{g as ae}from"../chunks/getStoreConfig.js";import*as R from"@dropins/tools/preact-compat.js";import{S as se,C as ce}from"../chunks/CartSummaryItem.js";import{a as ie}from"../chunks/OrderLoaders.js";import{useText as ue}from"@dropins/tools/i18n.js";import"../chunks/getFormValues.js";import"../chunks/network-error.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/transform-attributes-form.js";import"../chunks/convertCase.js";const oe=a=>R.createElement("svg",{id:"Icon_Warning_Base",width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...a},R.createElement("g",{clipPath:"url(#clip0_841_1324)"},R.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M11.9949 2.30237L0.802734 21.6977H23.1977L11.9949 2.30237Z",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round"}),R.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M12.4336 10.5504L12.3373 14.4766H11.6632L11.5669 10.5504V9.51273H12.4336V10.5504ZM11.5883 18.2636V17.2687H12.4229V18.2636H11.5883Z",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round"})),R.createElement("defs",null,R.createElement("clipPath",{id:"clip0_841_1324"},R.createElement("rect",{width:24,height:21,fill:"white",transform:"translate(0 1.5)"})))),le=a=>R.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...a},R.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M0.75 12C0.75 5.78421 5.78421 0.75 12 0.75C18.2158 0.75 23.25 5.78421 23.25 12C23.25 18.2158 18.2158 23.25 12 23.25C5.78421 23.25 0.75 18.2158 0.75 12Z",stroke:"currentColor"}),R.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M6.75 12.762L10.2385 15.75L17.25 9",stroke:"currentColor"})),de=({onSuccess:a,onError:s,handleSetInLineAlert:c,orderData:d})=>{const[h,o]=O({id:"",email:"",...d}),[y,b]=O("products"),[L,k]=O(!0),[p,l]=O([]),[_,C]=O([]),[t,S]=O({taxIncluded:!1,taxExcluded:!1}),[e,i]=O([]),[v,g]=O(""),f=z([]);f.current.length!==p.length&&(f.current=p.map((n,u)=>f.current[u]||K())),P(()=>{const n=G.on("order/data",u=>{o(u);const E=Y(u);i(E),k(!1)},{eager:!0});return()=>{n==null||n.off()}},[]),P(()=>{ae().then(n=>{if(!n)return;const u=J(n==null?void 0:n.shoppingCartDisplayPrice);S(u),g(n.baseMediaUrl)})},[]),P(()=>{ne("RMA_ITEM").then(n=>{n!=null&&n.length&&(C(n),k(!1))})},[]);const N=F(n=>{l(u=>u.findIndex(m=>(m==null?void 0:m.productSku)===(n==null?void 0:n.productSku))>-1?u.filter(m=>(m==null?void 0:m.productSku)!==(n==null?void 0:n.productSku)):[...u,n])},[]),x=F(n=>{b(n),c(),n==="products"&&l([])},[c]),M=F((n,u)=>{const E=p.map(m=>m.productSku===u?{...m,currentReturnOrderQuantity:n}:m);l(E)},[p]),Q=F(async(n,u)=>{if(!u)return;k(!0);const E={orderUid:h.id,contactEmail:h.email},m=I(f);re({...E,items:m}).then(T=>{a==null||a(T),x("success"),c()}).catch(T=>{s==null||s(T.message),c({type:"error",heading:T.message})}),k(!1)},[x,s,a,c,h]);return{order:{...h,placeholderImage:v},steps:y,loading:L,formsRef:f,taxConfig:t,attributesList:_,selectedProductList:p,itemsEligibleForReturn:e,handleSelectedProductList:N,handleSetQuantity:M,handleChangeStep:x,onSubmit:Q}},pe={success:le,warning:oe,error:se},he=()=>{const[a,s]=O({type:"success",heading:""}),c=F(d=>{if(!(d!=null&&d.type)){s({type:"success",heading:""});return}const h=r(H,{source:pe[d.type]});s({...d,icon:h})},[]);return{inLineAlertProps:a,handleSetInLineAlert:c}},me=({placeholderImage:a,itemsEligibleForReturn:s,slots:c,loading:d,taxConfig:h,translations:o,selectedProductList:y,handleSelectedProductList:b,showConfigurableOptions:L,handleSetQuantity:k,handleChangeStep:p})=>w("ul",{className:"order-return-order-product-list",children:[s==null?void 0:s.map((l,_)=>{const{quantityReturnRequested:C,quantityShipped:t,eligibleForReturn:S}=l,e=y.some(g=>(g==null?void 0:g.productSku)===l.productSku&&l.eligibleForReturn),i=t===C&&S,v=t-C===0?C:t-C;return w("li",{className:q(["order-return-order-product-list__item",["order-return-order-product-list__item--blur",i]]),children:[r($,{"data-testid":`key_${_}`,name:`key_${_}`,checked:e,disabled:i,onChange:()=>{b({...l,currentReturnOrderQuantity:1})}}),r(ce,{placeholderImage:a,loading:d,product:{...l,totalQuantity:v},itemType:"",taxConfig:h,translations:o,showConfigurableOptions:L,disabledIncrementer:!e,onQuantity:v>1?g=>{k(g,l.productSku)}:void 0}),r(B,{"data-testid":"returnOrderItem",name:"ReturnOrderItem",slot:c==null?void 0:c.ReturnOrderItem})]},l.id)}),r("li",{className:"order-return-order-product-list__item",children:r(A,{type:"button",onClick:()=>p("attributes"),disabled:!y.length,children:o.nextStep})})]}),ge=({routeReturnSuccess:a,translations:s,orderData:c})=>w("div",{className:"order-return-order-message",children:[r("p",{className:"order-return-order-message__title",children:s.successTitle}),r("p",{className:"order-return-order-message__subtitle",children:s.successMessage}),r(A,{href:(a==null?void 0:a(c))??"#",children:s.backStore})]}),fe=({slots:a,formsRef:s,selectedProductList:c,loading:d,fieldsConfig:h,translations:o,handleChangeStep:y,onSubmit:b})=>{const{formData:L,errors:k,formRef:p,handleChange:l,handleBlur:_,handleSubmit:C}=D({fieldsConfig:ee(h,c==null?void 0:c.length),onSubmit:b});return w("form",{className:"order-return-reason-form",ref:p,onSubmit:C,name:"returnReasonForm",children:[c.map((t,S)=>{var x,M,Q,n,u;const e=t==null?void 0:t.giftCard,i=t==null?void 0:t.product,v=te(h,S),g=`${t==null?void 0:t.id}_${S}`,f=(t==null?void 0:t.currentReturnOrderQuantity)??1,N={...t!=null&&t.currentReturnOrderQuantity?{[o.configurationsListQuantity]:f}:{},...t.configurableOptions||{},...t.bundleOptions||{},...e!=null&&e.senderName?{[o.sender]:e==null?void 0:e.senderName}:{},...e!=null&&e.senderEmail?{[o.sender]:e==null?void 0:e.senderEmail}:{},...e!=null&&e.recipientName?{[o.recipient]:e==null?void 0:e.recipientName}:{},...e!=null&&e.recipientEmail?{[o.recipient]:e==null?void 0:e.recipientEmail}:{},...e!=null&&e.message?{[o.message]:e==null?void 0:e.message}:{},...t!=null&&t.downloadableLinks?{[`${(x=t==null?void 0:t.downloadableLinks)==null?void 0:x.count} ${o.downloadableCount}`]:(M=t==null?void 0:t.downloadableLinks)==null?void 0:M.result}:{}};return w(X,{children:[r(W,{loading:d,title:r("div",{"data-testid":"product-name",children:(Q=t==null?void 0:t.product)==null?void 0:Q.name}),sku:r("div",{children:i==null?void 0:i.sku}),image:r(j,{src:((n=i==null?void 0:i.thumbnail)==null?void 0:n.url)??"",alt:((u=i==null?void 0:i.thumbnail)==null?void 0:u.label)??"",loading:"lazy",width:"90",height:"120"}),configurations:N}),r("form",{name:g,ref:s==null?void 0:s.current[S],"data-quantity":f,children:r(U,{className:"className",loading:d,fields:v,onChange:l,onBlur:_,errors:k,values:L})})]},t.id)}),r(B,{"data-testid":"returnFormActions",name:"ReturnFormActions",slot:a==null?void 0:a.ReturnFormActions,context:{handleChangeStep:y},children:w("div",{className:"order-return-reason-form__actions",children:[r(A,{variant:"secondary",type:"button",onClick:()=>{y("products")},children:o.backStep}),r(A,{children:o.submit})]})})]})},qe=({className:a,orderData:s,slots:c,onSuccess:d,onError:h,routeReturnSuccess:o,showConfigurableOptions:y})=>{const b=ue({headerText:"Order.CreateReturn.headerText",successTitle:"Order.CreateReturn.success.title",successMessage:"Order.CreateReturn.success.message",sender:"Order.CreateReturn.giftCard.sender",recipient:"Order.CreateReturn.giftCard.recipient",message:"Order.CreateReturn.giftCard.message",outOfStock:"Order.CreateReturn.stockStatus.outOfStock",nextStep:"Order.CreateReturn.buttons.nextStep",backStep:"Order.CreateReturn.buttons.backStep",submit:"Order.CreateReturn.buttons.submit",backStore:"Order.CreateReturn.buttons.backStore",downloadableCount:"Order.CreateReturn.downloadableCount",returnedItems:"Order.CreateReturn.returnedItems",configurationsListQuantity:"Order.CreateReturn.configurationsList.quantity"}),{inLineAlertProps:L,handleSetInLineAlert:k}=he(),{order:p,itemsEligibleForReturn:l,formsRef:_,taxConfig:C,attributesList:t,steps:S,loading:e,selectedProductList:i,handleSelectedProductList:v,handleSetQuantity:g,handleChangeStep:f,onSubmit:N}=de({orderData:s,onSuccess:d,onError:h,handleSetInLineAlert:k});if(e)return r("div",{children:r(ie,{})});if(!e&&!t.length)return r("div",{});const x={products:r(me,{itemsEligibleForReturn:l,placeholderImage:p==null?void 0:p.placeholderImage,slots:c,translations:b,loading:e,taxConfig:C,selectedProductList:i,handleSelectedProductList:v,showConfigurableOptions:y,handleSetQuantity:g,handleChangeStep:f}),attributes:r(fe,{slots:c,formsRef:_,loading:e,fieldsConfig:t,selectedProductList:i,handleChangeStep:f,translations:b,onSubmit:N}),success:r(ge,{translations:b,routeReturnSuccess:o,orderData:p}),error:null};return w("div",{className:q(["order-create-return",a]),children:[r(V,{title:b.headerText}),L.heading?r(Z,{className:"order-create-return_notification",variant:"secondary","data-testid":"orderCreateReturnNotification",...L}):null,x[S]]})};export{qe as CreateReturn,qe as default};
